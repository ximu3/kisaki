name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # =============================================================================
  # Check: Lint + Typecheck (fast feedback)
  # =============================================================================
  check:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

  # =============================================================================
  # Build Plugin Tooling: plugin-types → plugin-sdk → plugin-cli → create-kisaki-plugin
  # =============================================================================
  build-plugin-tooling:
    name: Build Plugin tooling Packages
    runs-on: ubuntu-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build plugin tooling packages
        run: pnpm build:plugin-tooling

      - name: Verify plugin tooling outputs
        run: |
          test -f packages/plugin-sdk/dist/main.mjs
          test -f packages/plugin-sdk/dist/renderer.mjs
          test -f packages/plugin-sdk/dist/main.d.mts
          test -f packages/plugin-sdk/dist/renderer.d.mts
          test -f packages/plugin-cli/dist/index.js
          test -f packages/create-kisaki-plugin/dist/index.js
          echo "✅ All plugin tooling outputs verified"

  # =============================================================================
  # Build App: Main Electron application (Windows only for now)
  # =============================================================================
  build-app:
    name: Build App (Windows)
    runs-on: windows-latest
    needs: check
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build:win

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kisaki-windows
          path: |
            apps/desktop/dist/*.exe
            apps/desktop/dist/latest.yml
          if-no-files-found: ignore
